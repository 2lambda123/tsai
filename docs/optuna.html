---

title: Optuna: A hyperparameter optimization framework


keywords: fastai
sidebar: home_sidebar

summary: "Optuna is an automatic hyperparameter optimization software framework, particularly designed for machine learning. It features an imperative, define-by-run style user API. Thanks to our define-by-run API, the code written with Optuna enjoys high modularity, and the user of Optuna can dynamically construct the search spaces for the hyperparameters."
description: "Optuna is an automatic hyperparameter optimization software framework, particularly designed for machine learning. It features an imperative, define-by-run style user API. Thanks to our define-by-run API, the code written with Optuna enjoys high modularity, and the user of Optuna can dynamically construct the search spaces for the hyperparameters."
nb_path: "nbs/200_optuna.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/200_optuna.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># from pathlib import Path</span>
<span class="c1"># from fastcore.script import *</span>
<span class="c1"># import joblib</span>
<span class="c1"># from tsai.imports import *</span>
<span class="c1"># from importlib import import_module</span>
<span class="c1"># import warnings</span>
<span class="c1"># warnings.filterwarnings(&quot;ignore&quot;)</span>


<span class="c1"># @call_parse</span>
<span class="c1"># def optuna_study(</span>
<span class="c1">#     config:             Param(&#39;Path to the study config file&#39;, str), </span>
<span class="c1">#     study_type:         Param(&#39;Type of study&#39;, str)=None,</span>
<span class="c1">#     multivariate:       Param(&#39;Flag to show progress bars or not.&#39;, store_false)=True,</span>
<span class="c1">#     study_name:         Param(&quot;Study&#39;s name. If this argument is set to None, a unique name is generated automatically.&quot;, str)=None, </span>
<span class="c1">#     seed:               Param(&#39;Seed for random number generator.&#39;, int)=None, </span>
<span class="c1">#     search_space:       Param(&#39;Path to dictionary whose keys and values are a parameter name and the corresponding candidates of values&#39;, str)=None, </span>
<span class="c1">#     direction:          Param(&#39;Direction of optimization.&#39;, str)=&#39;maximize&#39;,</span>
<span class="c1">#     n_trials:           Param(&#39;The number of trials.&#39;, int)=None, </span>
<span class="c1">#     timeout:            Param(&#39;Stop study after the given number of second(s).&#39;, int)=None, </span>
<span class="c1">#     gc_after_trial:     Param(&#39;Flag to determine whether to automatically run garbage collection after each trial.&#39;, store_true)=False,</span>
<span class="c1">#     show_progress_bar:  Param(&#39;Flag to show progress bars or not.&#39;, store_false)=True,</span>
<span class="c1">#     show_plots:         Param(&#39;Flag to show plots or not.&#39;, store_false)=True,</span>
<span class="c1">#     save:               Param(&#39;Flag to save study to disk or not.&#39;, store_false)=True,</span>
<span class="c1">#     path:               Param(&#39;Path where the study will be saved&#39;, str)=&#39;optuna&#39;, </span>
<span class="c1">#     ):</span>

<span class="c1">#     try: import optuna</span>
<span class="c1">#     except ImportError: raise ImportError(&#39;You need to install optuna!&#39;) </span>

<span class="c1">#     while True: </span>
<span class="c1">#         if config[0] in &quot;/ .&quot;: config = config.split(config[0], 1)[1]</span>
<span class="c1">#         else: break</span>
<span class="c1">#     if &#39;/&#39; in config and config.rsplit(&#39;/&#39;, 1)[0] not in sys.path: sys.path.append(config.rsplit(&#39;/&#39;, 1)[0])</span>
<span class="c1">#     m = import_file_as_module(config)</span>
<span class="c1">#     assert hasattr(m, &#39;objective&#39;), f&quot;there&#39;s no objective function in {config}&quot;</span>
<span class="c1">#     objective = getattr(m, &quot;objective&quot;)</span>

<span class="c1">#     if study_type is None or study_type.lower() == &quot;bayesian&quot;: sampler = optuna.samplers.TPESampler(seed=seed, multivariate=multivariate)</span>
<span class="c1">#     elif study_type.lower() in [&quot;gridsearch&quot;, &quot;gridsampler&quot;]: </span>
<span class="c1">#         assert hasattr(m, &#39;search_space&#39;), f&quot;there&#39;s no search_space function in {search_space}&quot;</span>
<span class="c1">#         search_space = getattr(m, &#39;search_space&#39;)</span>
<span class="c1">#         sampler = optuna.samplers.GridSampler(search_space=search_space)</span>
<span class="c1">#     elif study_type.lower() in [&quot;randomsearch&quot;, &quot;randomsampler&quot;]: sampler = optuna.samplers.RandomSampler(seed=seed)</span>
    
<span class="c1">#     try: </span>
<span class="c1">#         study = optuna.create_study(sampler=sampler, study_name=study_name, direction=direction)</span>
<span class="c1">#         study.optimize(objective, n_trials=n_trials, timeout=timeout, gc_after_trial=gc_after_trial, show_progress_bar=show_progress_bar)</span>
        
<span class="c1">#     except KeyboardInterrupt:</span>
<span class="c1">#         pass</span>

<span class="c1">#     if save: </span>
<span class="c1">#         full_path = Path(path)/f&#39;{study.study_name}.pkl&#39;</span>
<span class="c1">#         full_path.parent.mkdir(parents=True, exist_ok=True)</span>
<span class="c1">#         joblib.dump(study, full_path)</span>
<span class="c1">#         print(f&#39;\nOptuna study saved to {full_path}&#39;)</span>
<span class="c1">#         print(f&quot;To reload the study run: study = joblib.load(&#39;{full_path}&#39;)&quot;)</span>

<span class="c1">#     if show_plots and len(study.trials) &gt; 1: </span>
<span class="c1">#         try: display(optuna.visualization.plot_optimization_history(study))</span>
<span class="c1">#         except: pass</span>
<span class="c1">#         try: display(optuna.visualization.plot_param_importances(study))</span>
<span class="c1">#         except: pass</span>
<span class="c1">#         try: display(optuna.visualization.plot_slice(study))</span>
<span class="c1">#         except: pass</span>
<span class="c1">#         try: display(optuna.visualization.plot_parallel_coordinate(study))</span>
<span class="c1">#         except: pass</span>
    
<span class="c1">#     try: </span>
<span class="c1">#         print(f&quot;\nStudy stats   : &quot;)</span>
<span class="c1">#         print(f&quot;===============&quot;)</span>
<span class="c1">#         print(f&quot;Study name    : {study.study_name}&quot;)</span>
<span class="c1">#         print(f&quot;  n_trials    : {len(study.trials)}&quot;)</span>
<span class="c1">#         print(f&quot;Best trial    :&quot;)</span>
<span class="c1">#         trial = study.best_trial</span>
<span class="c1">#         print(f&quot;  value       : {trial.value}&quot;)</span>
<span class="c1">#         print(f&quot;  best_params = {trial.params}\n&quot;)</span>
<span class="c1">#     except:</span>
<span class="c1">#         print(&#39;No trials are completed yet.&#39;)</span>
<span class="c1">#     return study</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="retrieve_value" class="doc_header"><code>retrieve_value</code><a href="https://github.com/timeseriesAI/tsai/tree/main/tsai/optuna.py#L15" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>retrieve_value</code>(<strong><code>var</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_current_config" class="doc_header"><code>get_current_config</code><a href="https://github.com/timeseriesAI/tsai/tree/main/tsai/optuna.py#L19" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_current_config</code>(<strong><code>multi_value_dict</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">multi_config</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">:[</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="s1">&#39;dog&#39;</span><span class="p">]}</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;cat&quot;</span>
<span class="n">get_current_config</span><span class="p">(</span><span class="n">multi_config</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea output_execute_result">
<ul>
<li>a: 3</li>
<li>b: cat</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="run_optuna_study" class="doc_header"><code>run_optuna_study</code><a href="https://github.com/timeseriesAI/tsai/tree/main/tsai/optuna.py#L35" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>run_optuna_study</code>(<strong><code>objective</code></strong>, <strong><code>study_type</code></strong>=<em><code>None</code></em>, <strong><code>multivariate</code></strong>=<em><code>True</code></em>, <strong><code>search_space</code></strong>=<em><code>None</code></em>, <strong><code>seed</code></strong>=<em><code>None</code></em>, <strong><code>sampler</code></strong>=<em><code>None</code></em>, <strong><code>pruner</code></strong>=<em><code>None</code></em>, <strong><code>study_name</code></strong>=<em><code>None</code></em>, <strong><code>direction</code></strong>=<em><code>'maximize'</code></em>, <strong><code>load_if_exists</code></strong>=<em><code>False</code></em>, <strong><code>n_trials</code></strong>=<em><code>None</code></em>, <strong><code>timeout</code></strong>=<em><code>None</code></em>, <strong><code>gc_after_trial</code></strong>=<em><code>False</code></em>, <strong><code>show_progress_bar</code></strong>=<em><code>True</code></em>, <strong><code>save_study</code></strong>=<em><code>True</code></em>, <strong><code>path</code></strong>=<em><code>'optuna'</code></em>, <strong><code>show_plots</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Creates and runs an optuna study.</p>
<p>Args:
    objective:          A callable that implements objective function.
    study_type:         Type of study selected (bayesian, gridsearch, randomsearch). Based on this a sampler will be build if sampler is None.
                        If a sampler is passed, this has no effect.
    multivariate:       If this is True, the multivariate TPE is used when suggesting parameters. The multivariate TPE is reported to outperform
                        the independent TPE.
    search_space:       Search space required when running a gridsearch (if you don't pass a sampler).
    seed:               Fixed seed used by samplers.
    sampler:            A sampler object that implements background algorithm for value suggestion. If None is specified, TPESampler is used during
                        single-objective optimization and NSGAIISampler during multi-objective optimization. See also samplers.
    pruner:             A pruner object that decides early stopping of unpromising trials. If None is specified, MedianPruner is used as the default.
                        See also pruners.
    study_name:         Study’s name. If this argument is set to None, a unique name is generated automatically.
    direction:          A sequence of directions during multi-objective optimization.
    n_trials:           The number of trials. If this argument is set to None, there is no limitation on the number of trials. If timeout is also set to
                        None, the study continues to create trials until it receives a termination signal such as Ctrl+C or SIGTERM.
    timeout:            Stop study after the given number of second(s). If this argument is set to None, the study is executed without time limitation.
                        If n_trials is also set to None, the study continues to create trials until it receives a termination signal such as
                        Ctrl+C or SIGTERM.
    gc_after_trial:     Flag to execute garbage collection at the end of each trial. By default, garbage collection is enabled, just in case.
                        You can turn it off with this argument if memory is safely managed in your objective function.
    show_progress_bar:  Flag to show progress bars or not. To disable progress bar, set this False.
    save_study:         Save your study when finished/ interrupted.
    path:               Folder where the study will be saved.
    show_plots:         Flag to control whether plots are shown at the end of the study.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

